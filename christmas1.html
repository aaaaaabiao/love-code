<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Christmas Tree Animation</title>
    <style>
        body {
            background-color: #021F30;
            overflow: hidden;
            margin: 0;
        }
        * {
            touch-action: manipulation;
        }
    </style>
</head>
<body>
    <svg class="mainSVG" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
        viewBox="0 0 800 600">
        <defs>
            <circle id="circ" class="particle" cx="0" cy="0" r="1" />
            <path id="star" class="particle"
                d="M2.7,0l0.9,1.9l2,0.3L4,3.5l0.3,2l-1.8-1l-1.8,1l0.3-2L-0.5,2.2l2-0.3L2.7,0z" />
            <path id="cross" class="particle"
                d="M2.7,0.5L3.4,0.5L3.4,2.4L5.3,2.4L5.3,3.1L3.4,3.1L3.4,5L2.7,5L2.7,3.1L0.8,3.1L0.8,2.4L2.7,2.4L2.7,0.5z" />
            <path id="heart" class="particle" style="fill-rule:evenodd;clip-rule:evenodd;"
                d="M2.4,0.5c1.1,0,2,0.9,2,2c0,2-2,2-2,2s-2,0-2-2C0.4,1.4,1.3,0.5,2.4,0.5z" />
            <radialGradient id="grad" cx="3.9" cy="-0.8" r="7.8" gradientUnits="userSpaceOnUse">
                <stop offset="0" style="stop-color:#FFFFFF" />
                <stop offset="0.1" style="stop-color:#CCE6FF" />
                <stop offset="0.3" style="stop-color:#99CCFF" />
                <stop offset="0.6" style="stop-color:#66B2FF" />
                <stop offset="0.9" style="stop-color:#3399FF" />
                <stop offset="1" style="stop-color:#0080FF" />
            </radialGradient>
            <clipPath id="treePath">
                <path class="treePath"
                    d="M252.9,447.9c0,0-45.5-73.3,3.3-136.8s95.8-119.7,95.8-119.7s-3.8-45.6,42.7-83.8c46.5-38.2,91.4-26.9,91.4-26.9 s-32.6,26.9-19.1,83.8c13.5,56.9,67.1,41.5,67.1,41.5s-44.9,21.4-38.1,92.6c6.7,71.2,50.3,89.1,50.3,89.1s-94.7-7.9-126.9,60.3" />
            </clipPath>
            <clipPath id="treeBottomPath">
                <path class="treeBottomPath"
                    d="M253.3,448.5c0,0-4.1,8.6,4,8.6c8.1,0,189.3,0,189.3,0s8.2,0.9,8.2-7.7c0-8.6,0-8.6,0-8.6s-94.7-7.9-126.9,60.3" />
            </clipPath>
            <clipPath id="treePotPath">
                <path class="treePotPath"
                    d="M253.3,448.5c0,0-4.1,8.6,4,8.6c8.1,0,189.3,0,189.3,0s8.2,0.9,8.2-7.7c0-8.6,0-8.6,0-8.6" />
            </clipPath>
        </defs>
        <g class="whole">
            <g class="pContainer"></g>
            <g class="tree">
                <g id="treeGroup">
                    <path class="treePath"
                        d="M252.95,447.85c0,0-45.5-73.3,3.3-136.8s95.8-119.7,95.8-119.7s-3.8-45.6,42.7-83.8 c46.5-38.2,91.4-26.9,91.4-26.9s-32.6,26.9-19.1,83.8c13.5,56.9,67.1,41.5,67.1,41.5s-44.9,21.4-38.1,92.6 c6.7,71.2,50.3,89.1,50.3,89.1s-94.7-7.9-126.9,60.3"
                        fill="none" stroke="#FFF" stroke-width="2" stroke-linecap="round" />
                    <rect class="treePathMask" fill="url(#grad)" x="250" y="75" width="300" height="400"
                        clip-path="url(#treePath)" />
                    <rect class="treeBottomMask" fill="url(#grad)" x="250" y="75" width="300" height="400"
                        clip-path="url(#treeBottomPath)" />
                    <path class="treePot"
                        d="M253.3,448.5c0,0-4.1,8.6,4,8.6c8.1,0,189.3,0,189.3,0s8.2,0.9,8.2-7.7c0-8.6,0-8.6,0-8.6" fill="none"
                        stroke="#FFF" stroke-width="2" />
                    <rect class="treePotMask" fill="url(#grad)" x="250" y="440" width="300" height="20"
                        clip-path="url(#treePotPath)" />
                </g>
                <path class="treestar" opacity="0" fill="none" stroke="#FFF" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M421,84.2c-0.5,0.7-2.1,0.3-3.7-1.1c-1.5-1.3-2.4-2.9-1.9-3.6c0.5-0.7,2.1-0.3,3.7,1.1 C420.7,81.9,421.5,83.5,421,84.2z" />
                <path class="treestar" opacity="0" fill="none" stroke="#FFF" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M421.4,80c0,0.8-1.4,1.4-3.2,1.4c-1.8,0-3.2-0.6-3.2-1.4c0-0.8,1.4-1.4,3.2-1.4 C420,78.6,421.4,79.2,421.4,80z" />
                <path class="treestar" opacity="0" fill="none" stroke="#FFF" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M417,84.2c-0.5-0.7,0.4-2.3,1.9-3.6c1.5-1.3,3.1-1.8,3.7-1.1c0.5,0.7-0.4,2.3-1.9,3.6 C419.1,84.5,417.5,84.9,417,84.2z" />
                <path class="treestar" opacity="0" fill="none" stroke="#FFF" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M418.3,86c-0.8,0-1.4-1.4-1.4-3.2c0-1.8,0.6-3.2,1.4-3.2c0.8,0,1.4,1.4,1.4,3.2 C419.7,84.5,419.1,86,418.3,86z" />
                <path class="treestarOutline" opacity="0" fill="none" stroke="#FFF" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"
                    d="M418.3,76c2.4,0,4.3,3,4.3,6.8c0,3.7-1.9,6.8-4.3,6.8c-2.4,0-4.3-3-4.3-6.8 C414,79.1,415.9,76,418.3,76z" />
                <path class="sparkle" opacity="0" fill="none" stroke="#FFF" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M418.3,73.6c0.2,0,0.4,0.2,0.4,0.4c0,0.2-0.2,0.4-0.4,0.4c-0.2,0-0.4-0.2-0.4-0.4 C417.9,73.8,418.1,73.6,418.3,73.6z" />
                <path class="sparkle" opacity="0" fill="none" stroke="#FFF" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M418.3,91.6c0.2,0,0.4,0.2,0.4,0.4c0,0.2-0.2,0.4-0.4,0.4c-0.2,0-0.4-0.2-0.4-0.4 C417.9,91.8,418.1,91.6,418.3,91.6z" />
                <path class="sparkle" opacity="0" fill="none" stroke="#FFF" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M427.3,82.6c0.2,0,0.4,0.2,0.4,0.4c0,0.2-0.2,0.4-0.4,0.4c-0.2,0-0.4-0.2-0.4-0.4 C426.9,82.8,427.1,82.6,427.3,82.6z" />
                <path class="sparkle" opacity="0" fill="none" stroke="#FFF" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M409.3,82.6c0.2,0,0.4,0.2,0.4,0.4c0,0.2-0.2,0.4-0.4,0.4c-0.2,0-0.4-0.2-0.4-0.4 C408.9,82.8,409.1,82.6,409.3,82.6z" />
            </g>
        </g>
    </svg>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.4/gsap.min.js"></script>
    <script>
        window.addEventListener('load', function () {
            if (typeof gsap !== "undefined") {
                gsap.config({
                    trialWarn: false
                });
            }

            var xmlns = "http://www.w3.org/2000/svg",
                xlinkns = "http://www.w3.org/1999/xlink",
                select = function (s) {
                    return document.querySelector(s);
                },
                selectAll = function (s) {
                    return document.querySelectorAll(s);
                },
                pContainer = select('.pContainer'),
                mainSVG = select('.mainSVG'),
                star = select('#star'),
                sparkle = select('.sparkle'),
                tree = select('#tree'),
                showParticle = true,
                particleColorArray = ['#E8F6F8', '#ACE8F8', '#F6FBFE', '#A2CBDC', '#B74551', '#5DBA72', '#910B28', '#910B28', '#446D39'],
                particleTypeArray = ['#star', '#circ', '#cross', '#heart'],
                particlePool = [],
                particleCount = 0,
                numParticles = 201

            gsap.set('svg', {
                visibility: 'visible'
            })

            // 统一的事件处理函数
            function handleInteraction(event) {
                event.preventDefault();

                let x, y;

                if (event.type === 'touchstart') {
                    x = event.touches[0].clientX;
                    y = event.touches[0].clientY;
                } else if (event.type === 'click') {
                    x = event.clientX;
                    y = event.clientY;
                }

                let pt = mainSVG.createSVGPoint();
                pt.x = x;
                pt.y = y;
                let svgCoords = pt.matrixTransform(mainSVG.getScreenCTM().inverse());

                if (showParticle) {
                    particleCount++;
                    if (particleCount > numParticles) {
                        particleCount = 1;
                    }

                    var angle = Math.random() * Math.PI * 2;
                    var particleRadius = Math.random() * 0.5 + 3.5;
                    var particlePath = particleTypeArray[Math.floor(Math.random() * particleTypeArray.length)];
                    var rgb = particleColorArray[Math.floor(Math.random() * particleColorArray.length)];

                    var particleElement = document.createElementNS(xmlns, "use");
                    particleElement.setAttributeNS(xlinkns, "xlink:href", particlePath);
                    particleElement.setAttribute("class", "particle");
                    particleElement.setAttribute("transform", "translate(" + svgCoords.x + " " + svgCoords.y + ") scale(" + particleRadius + ")");
                    particleElement.setAttribute("fill", rgb);
                    particleElement.setAttribute("opacity", 0);
                    pContainer.appendChild(particleElement);

                    var tl = gsap.timeline();
                    tl.to(particleElement, {
                        duration: 0.6,
                        opacity: 1,
                        ease: "power1.inOut"
                    });
                    tl.to(particleElement, {
                        duration: 1,
                        x: Math.cos(angle) * 50,
                        y: Math.sin(angle) * 50,
                        ease: "power1.out"
                    }, '-=0.6');
                    tl.to(particleElement, {
                        duration: 0.3,
                        opacity: 0,
                        ease: "power1.inOut",
                        onComplete: function () {
                            pContainer.removeChild(particleElement);
                        }
                    });
                }
            }

            // 添加触摸事件监听
            mainSVG.addEventListener('touchstart', handleInteraction, { passive: false });

            // 添加鼠标点击事件监听
            mainSVG.addEventListener('click', handleInteraction);

            var mainTl = gsap.timeline({ delay: 0.5 });

            function drawMain() {
                gsap.set(".treePath", {
                    strokeDasharray: 1000,
                    strokeDashoffset: 1000,
                    stroke: "#FFF"
                });

                mainTl
                    .to(".treePath", {
                        duration: 6,
                        strokeDashoffset: 0,
                        ease: "linear"
                    })
                    .from([".treePathMask", ".treePotMask"], {
                        duration: 6,
                        scale: 0,
                        opacity: 0,
                        stagger: {
                            each: 6
                        },
                        ease: "linear"
                    }, "-=3")
                    .from(".treeStar", {
                        duration: 3,
                        scaleY: 0,
                        scaleX: 0.15,
                        transformOrigin: "50% 50%",
                        ease: "elastic(1,0.5)"
                    }, "-=4")
                    .to(".sparkle", {
                        duration: 3,
                        opacity: 0,
                        ease: "rough({strength: 2, points: 100, template: linear, taper: both, randomize: true, clamp: false})"
                    }, "-=0")
                    .to(".treeStarOutline", {
                        duration: 1,
                        opacity: 0.3,
                        ease: "rough({strength: 2, points: 16, template: linear, taper: none, randomize: true, clamp: false})"
                    }, "+=1");
            }

            drawMain();
        });
    </script>
</body>
</html>